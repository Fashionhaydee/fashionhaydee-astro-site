---
import Layout from '../layouts/Layout.astro';

const postImports = import.meta.glob('./blog/*.astro', { eager: true });

const allPosts = Object.entries(postImports).map(([path, mod]) => ({
  url: path.replace('./', '/blog/').replace('.astro', ''),
  ...mod.frontmatter
}));

// ✅ 按日期排序（确保文章含 date 字段）
allPosts.sort((a, b) => new Date(b.date) - new Date(a.date));

// ✅ 分页处理
const PAGE_SIZE = 5;
const page = Astro.url.searchParams.get('page') ?? '1';
const currentPage = parseInt(page);
const start = (currentPage - 1) * PAGE_SIZE;
const end = start + PAGE_SIZE;
const paginatedPosts = allPosts.slice(start, end);
const totalPages = Math.ceil(allPosts.length / PAGE_SIZE);

// ✅ 分类聚合
const byCategory = {};
for (const post of paginatedPosts) {
  const cat = post.category ?? 'Uncategorized';
  if (!byCategory[cat]) byCategory[cat] = [];
  byCategory[cat].push(post);
}
---

<Layout title="Jewelry Blog">
  <h1>Jewelry Journal · Explore by Theme</h1>

  {Object.entries(byCategory).map(([category, posts]) => (
    <section>
      <h2>{category}</h2>
      <ul>
        {posts.map((post) => (
          <li>
            <a href={post.url}><strong>{post.title}</strong></a><br />
            <p>{post.summary}</p>
          </li>
        ))}
      </ul>
    </section>
  ))}

  <nav style="margin-top: 2rem;">
    {Array.from({ length: totalPages }).map((_, i) => {
      const pageNum = i + 1;
      const isCurrent = pageNum === currentPage;
      return (
        <a
          href={`/blog?page=${pageNum}`}
          style={`margin-right: 0.5rem; font-weight: ${isCurrent ? 'bold' : 'normal'};`}
        >
          {pageNum}
        </a>
      );
    })}
  </nav>
</Layout>
